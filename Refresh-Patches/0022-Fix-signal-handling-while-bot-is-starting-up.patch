From 03a5929c965e9e9441349190040f10fcbb4fb8b2 Mon Sep 17 00:00:00 2001
From: Dabo Ross <daboross@daboross.net>
Date: Mon, 12 May 2014 15:33:05 -0700
Subject: [PATCH] Fix signal handling while bot is starting up


diff --git a/core/bot.py b/core/bot.py
index 91f27cb..ddd941a 100644
--- a/core/bot.py
+++ b/core/bot.py
@@ -73,7 +73,7 @@ class CloudBot:
     :type start_time: float
     :type running: bool
     :type do_restart: bool
-    :type connections: list[core.irc.BotConnection]
+    :type connections: list[core.connection.BotConnection]
     :type logger: logging.Logger
     :type data_dir: bytes
     :type config: core.config.Config
@@ -149,6 +149,9 @@ class CloudBot:
     def main_loop(self):
         # load plugins
         yield from self.plugin_manager.load_all(os.path.abspath("modules"))
+        # if we we're stopped while loading modules, cancel that and just stop
+        if not self.running:
+            return
         # start connections
         yield from asyncio.gather(*[conn.connect() for conn in self.connections], loop=self.loop)
         # run a manual garbage collection cycle, to clean up any unused objects created during initialization
@@ -189,6 +192,9 @@ class CloudBot:
         self.logger.info("Stopping bot.")
 
         for connection in self.connections:
+            if not connection.connected:
+                # Don't close a connection that hasn't connected
+                continue
             self.logger.debug("[{}] Closing connection.".format(connection.readable_name))
 
             if reason:
-- 
1.9.3

