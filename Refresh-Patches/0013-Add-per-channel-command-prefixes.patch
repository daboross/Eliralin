From d81dba7d5c3acb8fb6badf4775b7c260e5434bb1 Mon Sep 17 00:00:00 2001
From: Dabo Ross <daboross@daboross.net>
Date: Tue, 29 Apr 2014 02:58:21 -0700
Subject: [PATCH] Add per-channel command prefixes


diff --git a/plugins/prefixes.py b/plugins/prefixes.py
new file mode 100644
index 0000000..ab3f1ba
--- /dev/null
+++ b/plugins/prefixes.py
@@ -0,0 +1,109 @@
+import asyncio
+import re
+from sqlalchemy import Table, Column, String, UniqueConstraint
+
+from cloudbot import hook, botvars
+from cloudbot.core.events import CommandEvent
+from cloudbot.util import formatting
+
+
+table = Table(
+    "prefixes",
+    botvars.metadata,
+    Column("connection", String),
+    Column("channel", String),
+    Column("prefix", String),
+    UniqueConstraint("connection", "channel", "prefix")
+)
+
+
+def _load_db_query(db):
+    query = db.execute(table.select())
+    return [(row["connection"], row["channel"], row["prefix"]) for row in query]
+
+
+@asyncio.coroutine
+@hook.onload()
+def load_command_re(async, db):
+    """
+    :type db: sqlalchemy.orm.Session
+    """
+    global chan_re
+    channel_prefixes = {}
+    for connection, channel, prefix in async(_load_db_query, db):
+        key = (connection, channel)
+        if key in channel_prefixes:
+            channel_prefixes[key].append(re.escape(prefix))
+        else:
+            channel_prefixes[key] = [re.escape(prefix)]
+
+    chan_re = {}
+    for key, prefixes in channel_prefixes.items():
+        command_re = r"([{}])(\w+)(?:$|\s+)(.*)".format("".join(prefixes))
+        chan_re[key] = re.compile(command_re)
+
+
+@asyncio.coroutine
+@hook.command(permissions=["botcontrol"])
+def addprefix(text, conn, chan, async, db, logger):
+    """delprefix <prefix> - Adds a command prefix <prefix> to the current channel
+    :type text: str
+    :type chan: str
+    :type db: sqlalchemy.orm.Session
+    """
+    logger.info("Adding prefix {} to {}".format(text, chan))
+    yield from async(db.execute, table.insert().values(connection=conn.name, channel=chan, prefix=text))
+    yield from async(db.commit)
+    yield from load_command_re(async, db)
+    return "Added command prefix {} to {}".format(text, chan)
+
+
+@asyncio.coroutine
+@hook.command(permissions=["botcontrol"])
+def delprefix(text, chan, async, db, logger):
+    """delprefix <prefix> - Removes command prefix <prefix> from the current channel
+    :type text: str
+    :type chan: str
+    :type db: sqlalchemy.orm.Session
+    """
+    logger.info("Removing prefix {} from {}".format(text, chan))
+    yield from async(db.execute, table.delete().where(table.c.channel == chan).where(table.c.prefix == text))
+    yield from async(db.commit)
+    yield from load_command_re(async, db)
+    return "Removed command prefix {} from {}".format(text, chan)
+
+
+@asyncio.coroutine
+@hook.irc_raw("PRIVMSG")
+def run_extra_prefix(event, bot, conn, chan, irc_message):
+    """
+    :type event: cloudbot.core.events.BaseEvent
+    :type bot: cloudbot.core.bot.CloudBot
+    :type conn: cloudbot.core.connection.BotConnection
+    :type chan: str
+    :type irc_message: str
+    """
+    key = (conn.name, chan)
+    if key in chan_re:
+        match = chan_re[key].match(irc_message)
+        if match:
+            command = match.group(2).lower()
+            if command in bot.plugin_manager.commands:
+                command_hook = bot.plugin_manager.commands[command]
+                event = CommandEvent(triggered_command=command, hook=command_hook, text=match.group(3).strip(),
+                                     base_event=event)
+                yield from bot.plugin_manager.launch(command_hook, event)
+            else:
+                potential_matches = []
+                for potential_match, plugin in bot.plugin_manager.commands.items():
+                    if potential_match.startswith(command):
+                        potential_matches.append((potential_match, plugin))
+                if potential_matches:
+                    if len(potential_matches) == 1:
+                        command_hook = potential_matches[0][1]
+                        event = CommandEvent(triggered_command=command, hook=command_hook, text=match.group(3).strip(),
+                                             base_event=event)
+                        yield from bot.plugin_manager.launch(command_hook, event)
+                    else:
+                        event.notice("Possible matches: {}".format(
+                            formatting.get_text_list([command for command, plugin in potential_matches])))
-- 
2.0.0

