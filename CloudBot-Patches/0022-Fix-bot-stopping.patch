From f6e12f16c78528ff1c47d50afd5cd3559d358ec1 Mon Sep 17 00:00:00 2001
From: Dabo Ross <daboross@daboross.net>
Date: Sun, 1 Dec 2013 22:17:52 +0100
Subject: [PATCH] Fix bot stopping


diff --git a/cloudbot.py b/cloudbot.py
index 91515db..8e17d78 100755
--- a/cloudbot.py
+++ b/cloudbot.py
@@ -18,6 +18,7 @@ print 'CloudBot DEV <http://git.io/cloudbotirc>'
 # create new bot object
 bot = Bot()
 bot.vars = {}
+bot.stop = False
 
 # record start time for the uptime command
 bot.start_time = time.time()
@@ -60,7 +61,7 @@ if not os.path.exists(bot.persist_dir):
 
 print 'Connection(s) made, starting main loop.'
 
-while True:
+while not bot.stop:
     reload()  # these functions only do things
     config()  # if changes have occured
 
@@ -70,5 +71,5 @@ while True:
             main(conn, out)
         except Queue.Empty:
             pass
-    while all(conn.out.empty() for conn in bot.conns.itervalues()):
+    while all(conn.out.empty() for conn in bot.conns.itervalues()) and not bot.stop:
         time.sleep(.1)
diff --git a/plugins/admin.py b/plugins/admin.py
index 0aec0a2..9289c4b 100644
--- a/plugins/admin.py
+++ b/plugins/admin.py
@@ -104,13 +104,15 @@ def adduser(inp, bot=None, notice=None):
 
 @hook.command("quit", autohelp=False, permissions=["botcontrol"])
 @hook.command(autohelp=False, permissions=["botcontrol"])
-def stop(inp, nick=None, conn=None):
+def stop(inp, bot=None, nick=None, conn=None):
     """stop [reason] -- Kills the bot with [reason] as its quit message."""
     if inp:
         conn.cmd("QUIT", ["Killed by {} ({})".format(nick, inp)])
     else:
         conn.cmd("QUIT", ["Killed by {}.".format(nick)])
     time.sleep(5)
+    print "Quit - killed by {}".format(nick)
+    bot.stop = True
     sys.exit()
 
 
-- 
1.8.3.2

