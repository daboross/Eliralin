From cd5261c87790ec4ca217790a6567da52615ff43e Mon Sep 17 00:00:00 2001
From: Dabo Ross <daboross@daboross.net>
Date: Mon, 13 Jan 2014 23:18:39 -0800
Subject: [PATCH] Add per-channel regex filtering.


diff --git a/plugins/regex_chans.py b/plugins/regex_chans.py
new file mode 100644
index 0000000..f2f9fe4
--- /dev/null
+++ b/plugins/regex_chans.py
@@ -0,0 +1,131 @@
+from util import hook
+
+
+# Default value.
+# If True, all channels without a setting will have regex enabled
+# If False, all channels without a setting will have regex disabled
+default_enabled = True
+
+db_already_initiated = False
+
+
+def db_init(db):
+    global db_already_initiated
+    if not db_already_initiated:
+        db_already_initiated = True
+        db.execute("CREATE TABLE IF NOT EXISTS regexchans(channel PRIMARY KEY, status)")
+        db.commit()
+
+
+def get_status(db, channel):
+    row = db.execute("SELECT status FROM regexchans WHERE channel = ?", [channel]).fetchone()
+    if row:
+        return row[0]
+    else:
+        return None
+
+
+def set_status(db, channel, status):
+    row = db.execute("REPLACE INTO regexchans (channel, status) VALUES(?, ?)", [channel, status])
+    db.commit()
+
+
+def delete_status(db, channel):
+    row = db.execute("DELETE FROM regexchans WHERE channel = ?", [channel])
+    db.commit()
+
+
+def list_status(db):
+    row = db.execute("SELECT * FROM regexchans").fetchall()
+    result = ""
+    for values in row:
+        if result:
+            result += ", {}: {}".format(values[0], values[1])
+        else:
+            result = "{}: {}".format(values[0], values[1])
+    return result
+
+
+@hook.sieve
+def sieve_regex(bot, input, func, kind, args):
+    db = bot.get_db_connection(input.conn)
+    db_init(db)
+    if kind == 'regex' and input.chan.startswith("#") and func.__name__ != 'factoid':
+        chanstatus = get_status(db, input.chan)
+        if not chanstatus == "ENABLED" and (chanstatus == "DISABLED" or not default_enabled):
+            print "Denying input.raw={}, kind={}, args={} from {}".format(input.raw, kind, args, input.chan)
+            return None
+
+    print "Allowing input.raw={}, kind={}, args={} from {}".format(input.raw, kind, args, input.chan)
+    return input
+
+
+@hook.command(permissions=["botcontrol"])
+def enableregex(inp, db=None, message=None, notice=None, chan=None, nick=None):
+    db_init(db)
+    inp = inp.strip().lower()
+    if not inp:
+        channel = chan
+    elif inp.startswith("#"):
+        channel = inp
+    else:
+        channel = "#{}".format(inp)
+
+    print "Enabling regex matching (youtube, etc) in channel {} (issued by {})".format(channel, nick)
+    message("Enabling regex matching (youtube, etc) (issued by {})".format(nick), target=channel)
+    notice("Enabling regex matching (youtube, etc) in channel {}".format(channel))
+    set_status(db, channel, "ENABLED")
+
+
+@hook.command(permissions=["botcontrol"])
+def disableregex(inp, db=None, message=None, notice=None, chan=None, nick=None):
+    db_init(db)
+    inp = inp.strip().lower()
+    if not inp:
+        channel = chan
+    elif inp.startswith("#"):
+        channel = inp
+    else:
+        channel = "#{}".format(inp)
+
+    print "Disabling regex matching (youtube, etc) in channel {} (issued by {})".format(channel, nick)
+    message("Disabling regex matching (youtube, etc) (issued by {})".format(nick), target=channel)
+    notice("Disabling regex matching (youtube, etc) in channel {}".format(channel))
+    set_status(db, channel, "DISABLED")
+
+
+@hook.command(permissions=["botcontrol"])
+def resetregex(inp, db=None, message=None, notice=None, chan=None, nick=None):
+    db_init(db)
+    inp = inp.strip().lower()
+    if not inp:
+        channel = chan
+    elif inp.startswith("#"):
+        channel = inp
+    else:
+        channel = "#{}".format(inp)
+
+    print "Resetting regex matching setting (youtube, etc) in channel {} (issued by {})".format(channel, nick)
+    message("Resetting regex matching setting (youtube, etc) (issued by {})".format(nick), target=channel)
+    notice("Resetting regex matching setting (youtube, etc) in channel {}".format(channel))
+    delete_status(db, channel)
+
+
+@hook.command(permissions=["botcontrol"])
+def regexstatus(inp, db=None, chan=None):
+    db_init(db)
+    inp = inp.strip().lower()
+    if not inp:
+        channel = chan
+    elif inp.startswith("#"):
+        channel = inp
+    else:
+        channel = "#{}".format(inp)
+
+    return "Regex status for {}: {}".format(channel, get_status(db, channel))
+
+
+@hook.command(permissions=["botcontrol"])
+def listregex(inp, db=None):
+    db_init(db)
+    return list_status(db)
-- 
1.8.3.2

